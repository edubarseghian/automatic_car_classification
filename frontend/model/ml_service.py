import PIL
from tensorflow.keras.preprocessing import image
#from tensorflow.keras.applications.resnet50 import decode_predictions, preprocess_input
from tensorflow.keras.applications.efficientnet import decode_predictions, preprocess_input
#from tensorflow.keras.applications import resnet50
from tensorflow.keras.applications.efficientnet import EfficientNetB0
from tensorflow import keras
import json
import os
import time
from remove_background import get_vehicle_coordinates
import cv2

import numpy as np
import redis
import settings
#import pandas as pd
import tensorflow as tf

tf.config.set_visible_devices([], 'GPU')

# if tf.test.gpu_device_name(): # this lies and tells you about all devices
if tf.config.experimental.list_logical_devices('GPU'):
    print('GPU found')
else:
    print("No GPU found")


# os.environ['TF_CPP_MIN_LOG_LEVEL'] = '2'
# os.environ['CUDA_VISIBLE_DEVICES'] = '-1'

# TODO
# Connect to Redis and assign to variable `db``
# Make use of settings.py module to get Redis settings like host, port, etc.
#db = redis.StrictRedis(host='127.0.0.1', port=6379, db=0)
db = redis.StrictRedis(
    host=settings.REDIS_IP, port=settings.REDIS_PORT, db=settings.REDIS_DB_ID)

# TODO
# Load your ML model and assign to variable `model`
# See https://drive.google.com/file/d/1ADuBSE4z2ZVIdn66YDSwxKv-58U7WEOn/view?usp=sharing
# for more information about how to use this model.
#model = resnet50.ResNet50(include_top=True, weights="imagenet")
weights = os.path.join(settings.UPLOAD_FOLDER, "model.25-0.3795-0.9380.h5")
#model = resnet50.ResNet50(include_top=True, weights="imagenet")
#model = EfficientNetB0(include_top=True, weights=weights)
model = keras.models.load_model(str(weights))
print(model.summary())
#518 classes
class_names=['abarth_124', 'abarth_500', 'alfa-romeo_147', 'alfa-romeo_156', 'alfa-romeo_159', 'alfa-romeo_4c', 'alfa-romeo_giulia', 'alfa-romeo_giulietta', 'alfa-romeo_gt', 'alfa-romeo_mito', 'alfa-romeo_spider', 'alfa-romeo_stelvio', 'aston-martin_db11', 'aston-martin_db9', 'aston-martin_v8', 'audi_a1', 'audi_a2', 'audi_a3', 'audi_a4', 'audi_a4-allroad', 'audi_a5', 'audi_a6', 'audi_a6-allroad', 'audi_a7', 'audi_a8', 'audi_q2', 'audi_q3', 'audi_q5', 'audi_q7', 'audi_r8', 'audi_rs', 'audi_tt', 'bentley_bentayga', 'bentley_continental', 'bmw_i3', 'bmw_i8', 'bmw_m1', 'bmw_m2', 'bmw_m3', 'bmw_m4', 'bmw_m5', 'bmw_m6', 'bmw_serie_1', 'bmw_serie_2', 'bmw_serie_3', 'bmw_serie_4', 'bmw_serie_5', 'bmw_serie_6', 'bmw_serie_7', 'bmw_x1', 'bmw_x2', 'bmw_x3', 'bmw_x4', 'bmw_x5', 'bmw_x6', 'bmw_z3', 'bmw_z4', 'bmw_z8', 'chevrolet_aveo', 'chevrolet_camaro', 'chevrolet_captiva', 'chevrolet_cruze', 'chevrolet_epica', 'chevrolet_kalos', 'chevrolet_matiz', 'chevrolet_nubira', 'chevrolet_orlando', 'chevrolet_spark', 'chevrolet_tacuma', 'chevrolet_trax', 'chrysler_300c', 'chrysler_crossfire', 'chrysler_pt-cruiser', 'chrysler_sebring', 'chrysler_voyager', 'citroen_berlingo', 'citroen_c-crosser', 'citroen_c-elysÃ©e', 'citroen_c-zero', 'citroen_c1', 'citroen_c2', 'citroen_c3', 'citroen_c3-aircross', 'citroen_c3-picasso', 'citroen_c4', 'citroen_c4-aircross', 'citroen_c4-cactus', 'citroen_c4-picasso', 'citroen_c5', 'citroen_c6', 'citroen_c8', 'citroen_ds3', 'citroen_ds4', 'citroen_ds5', 'citroen_grand-c4-picasso', 'citroen_jumper', 'citroen_jumpy', 'citroen_nemo', 'citroen_saxo', 'citroen_spacetourer', 'citroen_xsara', 'citroen_xsara-picasso', 'dacia_dokker', 'dacia_duster', 'dacia_lodgy', 'dacia_logan', 'dacia_sandero', 'daihatsu_cuore', 'daihatsu_terios', 'dodge_caliber', 'dodge_challenger', 'dodge_journey', 'dodge_nitro', 'dodge_ram', 'ferrari_360', 'ferrari_458', 'ferrari_488', 'ferrari_575', 'ferrari_599', 'ferrari_612', 'ferrari_california', 'ferrari_f12', 'ferrari_f430', 'ferrari_ff', 'ferrari_gtc4-lusso', 'fiat_500', 'fiat_500l', 'fiat_500x', 'fiat_600', 'fiat_barchetta', 'fiat_bravo', 'fiat_croma', 'fiat_doblo', 'fiat_ducato', 'fiat_fiorino', 'fiat_freemont', 'fiat_fullback', 'fiat_idea', 'fiat_multipla', 'fiat_panda', 'fiat_punto', 'fiat_qubo', 'fiat_scudo', 'fiat_sedici', 'fiat_stilo', 'fiat_talento', 'fiat_tipo', 'fiat_ulysse', 'ford_b-max', 'ford_c-max', 'ford_ecosport', 'ford_edge', 'ford_f-150', 'ford_fiesta', 'ford_focus', 'ford_fusion', 'ford_galaxy', 'ford_kuga', 'ford_mondeo', 'ford_mustang', 'ford_ranger', 'ford_s-max', 'ford_streetka', 'ford_tourneo', 'ford_transit', 'honda_accord', 'honda_civic', 'honda_cr-v', 'honda_cr-z', 'honda_fr-v', 'honda_hr-v', 'honda_insight', 'honda_jazz', 'hummer_h2', 'hummer_h3', 'hyundai_accent', 'hyundai_atos', 'hyundai_coupe', 'hyundai_getz', 'hyundai_grand-santa-fe', 'hyundai_h-1', 'hyundai_h-350', 'hyundai_i10', 'hyundai_i20', 'hyundai_i30', 'hyundai_i40', 'hyundai_ioniq', 'hyundai_ix20', 'hyundai_ix35', 'hyundai_kona', 'hyundai_matrix', 'hyundai_santa-fe', 'hyundai_terracan', 'hyundai_tucson', 'hyundai_veloster', 'infiniti_fx', 'infiniti_q30', 'infiniti_q50', 'infiniti_qx30', 'infiniti_qx70', 'isuzu_d-max', 'iveco_daily', 'jaguar_f-pace', 'jaguar_f-type', 'jaguar_s-type', 'jaguar_x-type', 'jaguar_xe', 'jaguar_xf', 'jaguar_xj', 'jaguar_xk', 'jaguar_xkr', 'jeep_cherokee', 'jeep_commander', 'jeep_compass', 'jeep_grand-cherokee', 'jeep_patriot', 'jeep_renegade', 'jeep_wrangler', 'kia_carens', 'kia_carnival', 'kia_cerato', 'kia_niro', 'kia_optima', 'kia_picanto', 'kia_pro_ceed', 'kia_rio', 'kia_sorento', 'kia_soul', 'kia_sportage', 'kia_stinger', 'kia_stonic', 'kia_venga', 'lamborghini_aventador', 'lamborghini_gallardo', 'lamborghini_huracan', 'lancia_delta', 'lancia_lybra', 'lancia_musa', 'lancia_phedra', 'lancia_thema', 'lancia_thesis', 'lancia_voyager', 'lancia_y', 'lancia_ypsilon', 'land-rover_defender', 'land-rover_discovery', 'land-rover_discovery-sport', 'land-rover_freelander', 'land-rover_range-rover', 'land-rover_range-rover-evoque', 'land-rover_range-rover-sport', 'land-rover_range-rover-velar', 'lexus_ct-200h', 'lexus_is-220d', 'lexus_is-300', 'lexus_nx-300h', 'lexus_rx-450h', 'ligier_js', 'maserati_ghibli', 'maserati_granturismo', 'maserati_levante', 'maserati_quattroporte', 'mazda_2', 'mazda_3', 'mazda_323', 'mazda_5', 'mazda_6', 'mazda_626', 'mazda_cx-3', 'mazda_cx-5', 'mazda_cx-7', 'mazda_demio', 'mazda_mx-5', 'mazda_premacy', 'mazda_rx-8', 'mercedes-benz_amg-gt', 'mercedes-benz_atego', 'mercedes-benz_citan', 'mercedes-benz_cl-500', 'mercedes-benz_cla', 'mercedes-benz_class_a', 'mercedes-benz_class_b', 'mercedes-benz_class_c', 'mercedes-benz_class_e', 'mercedes-benz_class_g', 'mercedes-benz_class_r', 'mercedes-benz_class_s', 'mercedes-benz_class_v', 'mercedes-benz_class_x', 'mercedes-benz_clk', 'mercedes-benz_cls', 'mercedes-benz_gl-320', 'mercedes-benz_gl-350', 'mercedes-benz_gla', 'mercedes-benz_glc', 'mercedes-benz_gle', 'mercedes-benz_glk', 'mercedes-benz_gls-350', 'mercedes-benz_ml', 'mercedes-benz_sl', 'mercedes-benz_slc', 'mercedes-benz_slk', 'mercedes-benz_sls', 'mercedes-benz_sprinter', 'mercedes-benz_vaneo', 'mercedes-benz_viano', 'mercedes-benz_vito', 'mg_mgf', 'mg_tf', 'mini_cooper-cabrio', 'mini_cooper-clubman', 'mini_cooper-countryman', 'mini_cooper-paceman', 'mini_john-cooper-works', 'mini_john-cooper-works-clubman', 'mitsubishi_asx', 'mitsubishi_carisma', 'mitsubishi_colt', 'mitsubishi_grandis', 'mitsubishi_l200', 'mitsubishi_lancer', 'mitsubishi_outlander', 'mitsubishi_pajero', 'mitsubishi_pajero-pinin', 'mitsubishi_space-star', 'nissan_350z', 'nissan_370z', 'nissan_almera', 'nissan_almera-tino', 'nissan_gt-r', 'nissan_juke', 'nissan_leaf', 'nissan_micra', 'nissan_murano', 'nissan_navara', 'nissan_note', 'nissan_nv200', 'nissan_nv300', 'nissan_nv400', 'nissan_pathfinder', 'nissan_patrol', 'nissan_pixo', 'nissan_primastar', 'nissan_primera', 'nissan_pulsar', 'nissan_qashqai', 'nissan_terrano-ii', 'nissan_x-trail', 'opel_adam', 'opel_agila', 'opel_ampera', 'opel_antara', 'opel_astra', 'opel_cascada', 'opel_combo', 'opel_corsa', 'opel_crossland-x', 'opel_grandland-x', 'opel_gt', 'opel_insignia', 'opel_karl', 'opel_meriva', 'opel_mokka', 'opel_movano', 'opel_omega', 'opel_signum', 'opel_tigra', 'opel_vectra', 'opel_vivaro', 'opel_zafira', 'peugeot_1007', 'peugeot_106', 'peugeot_107', 'peugeot_108', 'peugeot_2008', 'peugeot_206', 'peugeot_207', 'peugeot_208', 'peugeot_3008', 'peugeot_306', 'peugeot_307', 'peugeot_308', 'peugeot_4007', 'peugeot_4008', 'peugeot_406', 'peugeot_407', 'peugeot_5008', 'peugeot_508', 'peugeot_607', 'peugeot_807', 'peugeot_bipper', 'peugeot_boxer', 'peugeot_expert', 'peugeot_partner', 'peugeot_rcz', 'peugeot_traveller', 'porsche_911', 'porsche_boxster', 'porsche_cayenne', 'porsche_cayman', 'porsche_macan', 'porsche_panamera', 'renault_alaskan', 'renault_captur', 'renault_clio', 'renault_espace', 'renault_fluence', 'renault_grand-modus', 'renault_kadjar', 'renault_kangoo', 'renault_koleos', 'renault_laguna', 'renault_master', 'renault_megane', 'renault_modus', 'renault_scenic', 'renault_talisman', 'renault_trafic', 'renault_twingo', 'renault_twizy', 'renault_wind', 'renault_zoe', 'rover_75', 'saab_9-3', 'saab_9-5', 'seat_alhambra', 'seat_altea', 'seat_altea-xl', 'seat_arona', 'seat_arosa', 'seat_ateca', 'seat_cordoba', 'seat_exeo', 'seat_ibiza', 'seat_leon', 'seat_mii', 'seat_toledo', 'skoda_citigo', 'skoda_fabia', 'skoda_karoq', 'skoda_kodiaq', 'skoda_octavia', 'skoda_rapid_spaceback', 'skoda_roomster', 'skoda_superb', 'skoda_yeti', 'smart_city-coupe-cabrio', 'smart_forfour', 'smart_fortwo', 'smart_roadster', 'ssangyong_actyon', 'ssangyong_korando', 'ssangyong_kyron', 'ssangyong_rexton', 'ssangyong_tivoli', 'ssangyong_xlv', 'subaru_forester', 'subaru_impreza', 'subaru_legacy', 'subaru_levorg', 'subaru_outback', 'subaru_trezia', 'subaru_xv', 'suzuki_alto', 'suzuki_baleno', 'suzuki_celerio', 'suzuki_grand-vitara', 'suzuki_ignis', 'suzuki_jimny', 'suzuki_liana', 'suzuki_splash', 'suzuki_swift', 'suzuki_sx4', 'suzuki_sx4-s-cross', 'suzuki_vitara', 'suzuki_wagon-r+', 'tesla_model-s', 'tesla_model-x', 'toyota_celica', 'toyota_corolla', 'toyota_land-cruiser', 'toyota_prius', 'volkswagen_amarok', 'volkswagen_arteon', 'volkswagen_beetle', 'volkswagen_bora', 'volkswagen_caddy', 'volkswagen_crafter', 'volkswagen_eos', 'volkswagen_fox', 'volkswagen_golf', 'volkswagen_golf-cabriolet', 'volkswagen_golf-plus', 'volkswagen_golf-sportsvan', 'volkswagen_golf-variant', 'volkswagen_jetta', 'volkswagen_lt', 'volkswagen_lupo', 'volkswagen_passat', 'volkswagen_passat-cc', 'volkswagen_phaeton', 'volkswagen_polo', 'volkswagen_polo-cross', 'volkswagen_polo-gti', 'volkswagen_scirocco', 'volkswagen_sharan', 'volkswagen_t-roc', 'volkswagen_t4', 'volkswagen_t5', 'volkswagen_t6', 'volkswagen_tiguan', 'volkswagen_touareg', 'volkswagen_touran', 'volkswagen_up!']
#763 classes
# class_names=['abarth_124-spider', 'abarth_500', 'abarth_500c', 'abarth_595', 'abarth_595-competizione', 'abarth_595-turismo', 'abarth_595c', 'abarth_grande-punto', 'abarth_punto-evo', 'alfa-romeo_147', 'alfa-romeo_156', 'alfa-romeo_159', 'alfa-romeo_4c', 'alfa-romeo_giulia', 'alfa-romeo_giulietta', 'alfa-romeo_gt', 'alfa-romeo_mito', 'alfa-romeo_spider', 'alfa-romeo_stelvio', 'aston-martin_db11', 'aston-martin_db9', 'aston-martin_v8', 'audi_a1', 'audi_a2', 'audi_a3', 'audi_a4', 'audi_a4-allroad', 'audi_a5', 'audi_a6', 'audi_a6-allroad', 'audi_a7', 'audi_a8', 'audi_q2', 'audi_q3', 'audi_q5', 'audi_q7', 'audi_r8', 'audi_rs', 'audi_rs-q3', 'audi_rs3', 'audi_rs4', 'audi_rs5', 'audi_rs6', 'audi_s1', 'audi_s3', 'audi_s4', 'audi_s5', 'audi_s6', 'audi_s7', 'audi_s8', 'audi_sq5', 'audi_sq7', 'audi_tt', 'audi_tt-rs', 'audi_tts', 'bentley_bentayga', 'bentley_continental', 'bmw_114', 'bmw_116', 'bmw_118', 'bmw_120', 'bmw_123', 'bmw_125', 'bmw_135', 'bmw_140', 'bmw_1er-m-coupé', 'bmw_214', 'bmw_216', 'bmw_218', 'bmw_220', 'bmw_225', 'bmw_228', 'bmw_230', 'bmw_235', 'bmw_240', 'bmw_316', 'bmw_318', 'bmw_320', 'bmw_325', 'bmw_328', 'bmw_330', 'bmw_335', 'bmw_340', 'bmw_418', 'bmw_420', 'bmw_425', 'bmw_428', 'bmw_430', 'bmw_435', 'bmw_440', 'bmw_518', 'bmw_520', 'bmw_523', 'bmw_525', 'bmw_528', 'bmw_530', 'bmw_535', 'bmw_540', 'bmw_550', 'bmw_630', 'bmw_635', 'bmw_640', 'bmw_645', 'bmw_650', 'bmw_730', 'bmw_740', 'bmw_745', 'bmw_750', 'bmw_i3', 'bmw_i8', 'bmw_m2', 'bmw_m3', 'bmw_m4', 'bmw_m5', 'bmw_m6', 'bmw_x1', 'bmw_x2', 'bmw_x3', 'bmw_x4', 'bmw_x4-m', 'bmw_x5', 'bmw_x5-m', 'bmw_x6', 'bmw_x6-m', 'bmw_z3', 'bmw_z4', 'bmw_z8', 'caravans-wohnm_others', 'chevrolet_aveo', 'chevrolet_camaro', 'chevrolet_captiva', 'chevrolet_cruze', 'chevrolet_epica', 'chevrolet_kalos', 'chevrolet_matiz', 'chevrolet_nubira', 'chevrolet_orlando', 'chevrolet_spark', 'chevrolet_tacuma', 'chevrolet_trax', 'chrysler_300c', 'chrysler_crossfire', 'chrysler_grand-voyager', 'chrysler_pt-cruiser', 'chrysler_sebring', 'chrysler_voyager', 'citroen_berlingo', 'citroen_c-crosser', 'citroen_c-elysée', 'citroen_c-zero', 'citroen_c1', 'citroen_c2', 'citroen_c3', 'citroen_c3-aircross', 'citroen_c3-picasso', 'citroen_c4', 'citroen_c4-aircross', 'citroen_c4-cactus', 'citroen_c4-picasso', 'citroen_c5', 'citroen_c6', 'citroen_c8', 'citroen_ds3', 'citroen_ds4', 'citroen_ds5', 'citroen_grand-c4-picasso', 'citroen_jumper', 'citroen_jumpy', 'citroen_nemo', 'citroen_saxo', 'citroen_spacetourer', 'citroen_xsara', 'citroen_xsara-picasso', 'dacia_dokker', 'dacia_duster', 'dacia_lodgy', 'dacia_logan', 'dacia_sandero', 'daewoo_kalos', 'daewoo_matiz', 'daewoo_tacuma', 'daihatsu_cuore', 'daihatsu_sirion', 'daihatsu_terios', 'dodge_caliber', 'dodge_challenger', 'dodge_journey', 'dodge_nitro', 'dodge_ram', 'ds-automobiles_ds-3', 'ds-automobiles_ds-4', 'ds-automobiles_ds-5', 'ferrari_360', 'ferrari_458', 'ferrari_488', 'ferrari_575', 'ferrari_599', 'ferrari_612', 'ferrari_california', 'ferrari_f12', 'ferrari_f430', 'ferrari_ff', 'ferrari_gtc4-lusso', 'fiat_124-spider', 'fiat_500', 'fiat_500c', 'fiat_500l', 'fiat_500x', 'fiat_600', 'fiat_barchetta', 'fiat_bravo', 'fiat_croma', 'fiat_doblo', 'fiat_ducato', 'fiat_fiorino', 'fiat_freemont', 'fiat_fullback', 'fiat_grande-punto', 'fiat_idea', 'fiat_multipla', 'fiat_new-panda', 'fiat_panda', 'fiat_punto', 'fiat_punto-evo', 'fiat_qubo', 'fiat_scudo', 'fiat_sedici', 'fiat_seicento', 'fiat_stilo', 'fiat_talento', 'fiat_tipo', 'fiat_ulysse', 'ford_b-max', 'ford_c-max', 'ford_ecosport', 'ford_edge', 'ford_f-150', 'ford_fiesta', 'ford_focus', 'ford_focus-c-max', 'ford_focus-cc', 'ford_fusion', 'ford_galaxy', 'ford_grand-c-max', 'ford_kuga', 'ford_mondeo', 'ford_mustang', 'ford_ranger', 'ford_s-max', 'ford_streetka', 'ford_tourneo', 'ford_tourneo-connect', 'ford_tourneo-courier', 'ford_tourneo-custom', 'ford_transit', 'ford_transit-connect', 'ford_transit-courier', 'ford_transit-custom', 'honda_accord', 'honda_civic', 'honda_cr-v', 'honda_cr-z', 'honda_fr-v', 'honda_hr-v', 'honda_insight', 'honda_jazz', 'hummer_h2', 'hummer_h3', 'hyundai_accent', 'hyundai_atos', 'hyundai_coupe', 'hyundai_getz', 'hyundai_grand-santa-fe', 'hyundai_h-1', 'hyundai_h-350', 'hyundai_i10', 'hyundai_i20', 'hyundai_i30', 'hyundai_i40', 'hyundai_ioniq', 'hyundai_ix20', 'hyundai_ix35', 'hyundai_kona', 'hyundai_matrix', 'hyundai_santa-fe', 'hyundai_terracan', 'hyundai_tucson', 'hyundai_veloster', 'infiniti_fx', 'infiniti_q30', 'infiniti_q50', 'infiniti_qx30', 'infiniti_qx70', 'isuzu_d-max', 'iveco_daily', 'jaguar_f-pace', 'jaguar_f-type', 'jaguar_s-type', 'jaguar_x-type', 'jaguar_xe', 'jaguar_xf', 'jaguar_xj', 'jaguar_xk', 'jaguar_xkr', 'jeep_cherokee', 'jeep_commander', 'jeep_compass', 'jeep_grand-cherokee', 'jeep_patriot', 'jeep_renegade', 'jeep_wrangler', 'kia_carens', 'kia_carnival', 'kia_cerato', 'kia_niro', 'kia_optima', 'kia_picanto', 'kia_pro_ceed', 'kia_rio', 'kia_sorento', 'kia_soul', 'kia_sportage', 'kia_stinger', 'kia_stonic', 'kia_venga', 'lamborghini_aventador', 'lamborghini_gallardo', 'lamborghini_huracán', 'lancia_delta', 'lancia_lybra', 'lancia_musa', 'lancia_phedra', 'lancia_thema', 'lancia_thesis', 'lancia_voyager', 'lancia_y', 'lancia_ypsilon', 'land-rover_defender', 'land-rover_discovery', 'land-rover_discovery-sport', 'land-rover_freelander', 'land-rover_range-rover', 'land-rover_range-rover-evoque', 'land-rover_range-rover-sport', 'land-rover_range-rover-velar', 'lexus_ct-200h', 'lexus_is-220d', 'lexus_is-250', 'lexus_is-300', 'lexus_nx-300h', 'lexus_rx-450h', 'ligier_js', 'maserati_ghibli', 'maserati_granturismo', 'maserati_levante', 'maserati_quattroporte', 'mazda_2', 'mazda_3', 'mazda_323', 'mazda_5', 'mazda_6', 'mazda_626', 'mazda_cx-3', 'mazda_cx-5', 'mazda_cx-7', 'mazda_demio', 'mazda_mx-5', 'mazda_premacy', 'mazda_rx-8', 'mercedes-benz_180', 'mercedes-benz_200', 'mercedes-benz_220', 'mercedes-benz_250', 'mercedes-benz_350', 'mercedes-benz_a-140', 'mercedes-benz_a-150', 'mercedes-benz_a-160', 'mercedes-benz_a-170', 'mercedes-benz_a-180', 'mercedes-benz_a-190', 'mercedes-benz_a-200', 'mercedes-benz_a-220', 'mercedes-benz_a-250', 'mercedes-benz_a-45-amg', 'mercedes-benz_amg-gt', 'mercedes-benz_atego', 'mercedes-benz_b-150', 'mercedes-benz_b-160', 'mercedes-benz_b-170', 'mercedes-benz_b-180', 'mercedes-benz_b-200', 'mercedes-benz_b-220', 'mercedes-benz_b-250', 'mercedes-benz_c-180', 'mercedes-benz_c-200', 'mercedes-benz_c-220', 'mercedes-benz_c-230', 'mercedes-benz_c-240', 'mercedes-benz_c-250', 'mercedes-benz_c-270', 'mercedes-benz_c-280', 'mercedes-benz_c-300', 'mercedes-benz_c-320', 'mercedes-benz_c-350', 'mercedes-benz_c-400', 'mercedes-benz_c-43-amg', 'mercedes-benz_c-450', 'mercedes-benz_c-63-amg', 'mercedes-benz_citan', 'mercedes-benz_cl-500', 'mercedes-benz_cla-180', 'mercedes-benz_cla-200', 'mercedes-benz_cla-220', 'mercedes-benz_cla-250', 'mercedes-benz_cla-45-amg', 'mercedes-benz_clc', 'mercedes-benz_clk-200', 'mercedes-benz_clk-220', 'mercedes-benz_clk-230', 'mercedes-benz_clk-240', 'mercedes-benz_clk-270', 'mercedes-benz_clk-280', 'mercedes-benz_clk-320', 'mercedes-benz_cls', 'mercedes-benz_cls-220', 'mercedes-benz_cls-250', 'mercedes-benz_cls-320', 'mercedes-benz_cls-350', 'mercedes-benz_cls-400', 'mercedes-benz_cls-500', 'mercedes-benz_cls-63-amg', 'mercedes-benz_e-200', 'mercedes-benz_e-220', 'mercedes-benz_e-240', 'mercedes-benz_e-250', 'mercedes-benz_e-270', 'mercedes-benz_e-280', 'mercedes-benz_e-300', 'mercedes-benz_e-320', 'mercedes-benz_e-350', 'mercedes-benz_e-400', 'mercedes-benz_e-43-amg', 'mercedes-benz_e-500', 'mercedes-benz_e-63-amg', 'mercedes-benz_g-350', 'mercedes-benz_g-500', 'mercedes-benz_g-63-amg', 'mercedes-benz_gl-320', 'mercedes-benz_gl-350', 'mercedes-benz_gla-180', 'mercedes-benz_gla-200', 'mercedes-benz_gla-220', 'mercedes-benz_gla-250', 'mercedes-benz_gla-45-amg', 'mercedes-benz_glc-220', 'mercedes-benz_glc-250', 'mercedes-benz_glc-300', 'mercedes-benz_glc-350', 'mercedes-benz_glc-43-amg', 'mercedes-benz_gle-250', 'mercedes-benz_gle-350', 'mercedes-benz_gle-400', 'mercedes-benz_gle-43-amg', 'mercedes-benz_gle-450', 'mercedes-benz_gle-500', 'mercedes-benz_gle-63-amg', 'mercedes-benz_glk-200', 'mercedes-benz_glk-220', 'mercedes-benz_glk-250', 'mercedes-benz_glk-320', 'mercedes-benz_glk-350', 'mercedes-benz_gls-350', 'mercedes-benz_marco-polo', 'mercedes-benz_ml-250', 'mercedes-benz_ml-270', 'mercedes-benz_ml-280', 'mercedes-benz_ml-300', 'mercedes-benz_ml-320', 'mercedes-benz_ml-350', 'mercedes-benz_ml-63-amg', 'mercedes-benz_r-280', 'mercedes-benz_r-320', 'mercedes-benz_r-350', 'mercedes-benz_s-320', 'mercedes-benz_s-350', 'mercedes-benz_s-400', 'mercedes-benz_s-500', 'mercedes-benz_s-560', 'mercedes-benz_s-63-amg', 'mercedes-benz_sl-350', 'mercedes-benz_sl-500', 'mercedes-benz_sl-55-amg', 'mercedes-benz_slc-180', 'mercedes-benz_slc-200', 'mercedes-benz_slc-43-amg', 'mercedes-benz_slk-200', 'mercedes-benz_slk-230', 'mercedes-benz_slk-250', 'mercedes-benz_slk-280', 'mercedes-benz_slk-350', 'mercedes-benz_sls', 'mercedes-benz_sprinter', 'mercedes-benz_v', 'mercedes-benz_v-220', 'mercedes-benz_v-250', 'mercedes-benz_vaneo', 'mercedes-benz_viano', 'mercedes-benz_vito', 'mercedes-benz_x-250', 'mg_mgf', 'mg_tf', 'mini_cooper', 'mini_cooper-cabrio', 'mini_cooper-clubman', 'mini_cooper-countryman', 'mini_cooper-d', 'mini_cooper-d-cabrio', 'mini_cooper-d-clubman', 'mini_cooper-d-countryman', 'mini_cooper-d-paceman', 'mini_cooper-s', 'mini_cooper-s-cabrio', 'mini_cooper-s-clubman', 'mini_cooper-s-countryman', 'mini_cooper-s-paceman', 'mini_cooper-sd', 'mini_cooper-sd-clubman', 'mini_cooper-sd-countryman', 'mini_john-cooper-works', 'mini_john-cooper-works-clubman', 'mini_john-cooper-works-countryman', 'mini_one', 'mini_one-cabrio', 'mini_one-countryman', 'mini_one-d', 'mini_one-d-clubman', 'mini_one-d-countryman', 'mitsubishi_asx', 'mitsubishi_carisma', 'mitsubishi_colt', 'mitsubishi_grandis', 'mitsubishi_l200', 'mitsubishi_lancer', 'mitsubishi_outlander', 'mitsubishi_pajero', 'mitsubishi_pajero-pinin', 'mitsubishi_space-star', 'nissan_350z', 'nissan_370z', 'nissan_almera', 'nissan_almera-tino', 'nissan_gt-r', 'nissan_juke', 'nissan_leaf', 'nissan_micra', 'nissan_murano', 'nissan_navara', 'nissan_note', 'nissan_nv200', 'nissan_nv300', 'nissan_nv400', 'nissan_pathfinder', 'nissan_patrol', 'nissan_pixo', 'nissan_primastar', 'nissan_primera', 'nissan_pulsar', 'nissan_qashqai', 'nissan_qashqai+2', 'nissan_terrano-ii', 'nissan_x-trail', 'opel_adam', 'opel_agila', 'opel_ampera', 'opel_antara', 'opel_astra', 'opel_cascada', 'opel_combo', 'opel_corsa', 'opel_crossland-x', 'opel_grandland-x', 'opel_gt', 'opel_insignia', 'opel_karl', 'opel_meriva', 'opel_mokka', 'opel_movano', 'opel_omega', 'opel_signum', 'opel_tigra', 'opel_vectra', 'opel_vivaro', 'opel_zafira', 'opel_zafira-tourer', 'peugeot_1007', 'peugeot_106', 'peugeot_107', 'peugeot_108', 'peugeot_2008', 'peugeot_206', 'peugeot_207', 'peugeot_208', 'peugeot_3008', 'peugeot_306', 'peugeot_307', 'peugeot_308', 'peugeot_4007', 'peugeot_4008', 'peugeot_406', 'peugeot_407', 'peugeot_5008', 'peugeot_508', 'peugeot_607', 'peugeot_807', 'peugeot_bipper', 'peugeot_boxer', 'peugeot_expert', 'peugeot_partner', 'peugeot_rcz', 'peugeot_traveller', 'porsche_911', 'porsche_991', 'porsche_996', 'porsche_997', 'porsche_boxster', 'porsche_cayenne', 'porsche_cayman', 'porsche_macan', 'porsche_panamera', 'renault_alaskan', 'renault_captur', 'renault_clio', 'renault_espace', 'renault_fluence', 'renault_grand-espace', 'renault_grand-modus', 'renault_grand-scenic', 'renault_kadjar', 'renault_kangoo', 'renault_koleos', 'renault_laguna', 'renault_master', 'renault_megane', 'renault_modus', 'renault_scenic', 'renault_talisman', 'renault_trafic', 'renault_twingo', 'renault_twizy', 'renault_wind', 'renault_zoe', 'rover_75', 'saab_9-3', 'saab_9-5', 'seat_alhambra', 'seat_altea', 'seat_altea-xl', 'seat_arona', 'seat_arosa', 'seat_ateca', 'seat_cordoba', 'seat_exeo', 'seat_ibiza', 'seat_leon', 'seat_mii', 'seat_toledo', 'skoda_citigo', 'skoda_fabia', 'skoda_karoq', 'skoda_kodiaq', 'skoda_octavia', 'skoda_rapid%2fspaceback', 'skoda_roomster', 'skoda_superb', 'skoda_yeti', 'smart_brabus', 'smart_city-coupé%2fcity-cabrio', 'smart_forfour', 'smart_fortwo', 'smart_roadster', 'ssangyong_actyon', 'ssangyong_korando', 'ssangyong_kyron', 'ssangyong_rexton', 'ssangyong_tivoli', 'ssangyong_xlv', 'subaru_forester', 'subaru_impreza', 'subaru_justy', 'subaru_legacy', 'subaru_levorg', 'subaru_outback', 'subaru_trezia', 'subaru_xv', 'suzuki_alto', 'suzuki_baleno', 'suzuki_celerio', 'suzuki_grand-vitara', 'suzuki_ignis', 'suzuki_jimny', 'suzuki_liana', 'suzuki_splash', 'suzuki_swift', 'suzuki_sx4', 'suzuki_sx4-s-cross', 'suzuki_vitara', 'suzuki_wagon-r+', 'tesla_model-s', 'tesla_model-x', 'toyota_celica', 'toyota_corolla', 'toyota_land-cruiser', 'toyota_prius', 'volkswagen_amarok', 'volkswagen_arteon', 'volkswagen_beetle', 'volkswagen_bora', 'volkswagen_caddy', 'volkswagen_cc', 'volkswagen_coccinelle', 'volkswagen_crafter', 'volkswagen_eos', 'volkswagen_fox', 'volkswagen_golf', 'volkswagen_golf-cabriolet', 'volkswagen_golf-gti', 'volkswagen_golf-plus', 'volkswagen_golf-sportsvan', 'volkswagen_golf-variant', 'volkswagen_jetta', 'volkswagen_lt', 'volkswagen_lupo', 'volkswagen_maggiolino', 'volkswagen_new-beetle', 'volkswagen_others', 'volkswagen_passat', 'volkswagen_passat-alltrack', 'volkswagen_passat-cc', 'volkswagen_passat-variant', 'volkswagen_phaeton', 'volkswagen_polo', 'volkswagen_polo-cross', 'volkswagen_polo-gti', 'volkswagen_scirocco', 'volkswagen_sharan', 'volkswagen_t-roc', 'volkswagen_t4', 'volkswagen_t4-caravelle', 'volkswagen_t4-multivan', 'volkswagen_t5', 'volkswagen_t5-california', 'volkswagen_t5-caravelle', 'volkswagen_t5-kombi', 'volkswagen_t5-multivan', 'volkswagen_t6-california', 'volkswagen_t6-caravelle', 'volkswagen_t6-multivan', 'volkswagen_t6-transporter', 'volkswagen_tiguan', 'volkswagen_touareg', 'volkswagen_touran', 'volkswagen_transporter', 'volkswagen_up!']
def predict(image_name):
    class_name = None
    pred_probability = None

    path = os.path.join(settings.UPLOAD_FOLDER,image_name)
    #efficientnetB1
    img = image.load_img(path, target_size=(240, 240))
    #efficientnetB0
    #img = image.load_img(path, target_size=(224, 224))
    x = image.img_to_array(img)
    x_batch = np.expand_dims(x, axis=0)
    x_batch = keras.applications.efficientnet.preprocess_input(x_batch)
    pred = model.predict(x_batch)
    max_idx = np.argmax(pred)
    pred_probability = pred[0][max_idx]
    class_name = class_names[max_idx]
    return class_name, pred_probability


def classify_process():
    while True:
        if db.llen(settings.REDIS_QUEUE) != 0:
            que, data = db.brpop(settings.REDIS_QUEUE)
            imgRedis = json.loads(data)
            img_name = imgRedis['image_name']
            job_id = imgRedis['id']
            img = cv2.imread(os.path.join(settings.UPLOAD_FOLDER,img_name))
            coordinates = get_vehicle_coordinates(img)
            if coordinates[2]!=0:
                cropped_im = img[coordinates[1]:coordinates[3],coordinates[0]:coordinates[2],:]
                cv2.imwrite(os.path.join(settings.UPLOAD_FOLDER,img_name), cropped_im)
                PredictionClas, score = predict(img_name)
                job_Predict = {
                    'PredictionClas': PredictionClas,
                    'score': str(score)}
            else:
                job_Predict = {
                    'PredictionClas': 'No vehicle detected',
                    'score': '0'}
            ImgPredicted = json.dumps(job_Predict)
            # send back result to middleware
            db.set(job_id, ImgPredicted)
            time.sleep(settings.SERVER_SLEEP)


if __name__ == "__main__":
    print("Launching ML service...")
    classify_process()
